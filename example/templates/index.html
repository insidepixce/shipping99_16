<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>우리의 이야기</title>
    <style>
      *{
            font-family: 'Gowun Dodum', sans-serif;
        }
        .mytitle {
            width: 100%;
            height: 250px;
            background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
                url('https://media.istockphoto.com/id/1271177685/ko/벡터/하트-모양-모노-라인-연속-선-아이콘-손으로-그린-서예-요소-번창-클립-아트.jpg?s=612x612&w=0&k=20&c=Gs1qnIS-PhVuEh2b-cAKMG0l2Xicqr7lH_9Bu7cIbZY=');
            background-position: center;
            background-size: cover;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .mytitle > button {
            width: 200px;
            height: 50px;
            background-color: transparent;
            color: white;
            border-radius: 50px;
            border: 1px solid white;
            margin-top: 10px;
        }
        .mytitle > button:hover {
            border: 2px solid white;
        }
        .mycomment {
            color: gray;
        }
        .mycards {
            margin: 20px auto 0px auto;
            width: 95%;
            max-width: 1200px;
        }
        .mypost {
            width: 95%;
            max-width: 500px;
            margin: 20px auto 0px auto;
            padding: 20px;
            box-shadow: 0px 0px 3px 0px gray;
            display: none;
        }
        .mybtns {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="mytitle">
        <h1>내 생애 최고의 순간은 너랑 함께하는 시간이야</h1>
        <button id="addMovieButton">오늘 기록하기</button>
    </div>
    <div class="mypost">
        <input type="text" class="form-control mb-3" id="movieTitleInput" placeholder="오늘의 제목">
        <textarea class="form-control mb-3" placeholder="오늘 있었던 일" id="movieDescriptionTextarea" style="height: 100px"></textarea>
        <div class="input-group mb-3">
            <input type="file" class="form-control" id="imageUploadInput">
            <label class="input-group-text" for="imageUploadInput">사진 업로드</label>
        </div>
        <textarea class="form-control mb-3" placeholder="오늘 너한테 하고 싶은 말" id="myCommentTextarea" style="height: 100px"></textarea>
        <select class="form-select mb-3" id="ratingSelect">
            <option selected>-- 오늘의 기분은? --</option>
            <option value="1">⭐</option>
            <option value="2">⭐⭐</option>
            <option value="3">⭐⭐⭐</option>
            <option value="4">⭐⭐⭐⭐</option>
            <option value="5">⭐⭐⭐⭐⭐</option>
        </select>
        <div class="mybtns">
            <button type="button" class="btn btn-dark" id="submitButton">기록하기</button>
            <button type="button" class="btn btn-outline-dark" id="cancelButton">취소</button>
        </div>
    </div>
    <div class="mycards">
        <div class="row row-cols-1 row-cols-md-4 g-4" id="movieList"></div>
    </div>

    <script>
         
        const addMovieButton = document.getElementById("addMovieButton");
        const movieTitleInput = document.getElementById("movieTitleInput");
        const movieDescriptionTextarea = document.getElementById("movieDescriptionTextarea");
        const myCommentTextarea = document.getElementById("myCommentTextarea");
        const ratingSelect = document.getElementById("ratingSelect");
        const imageUploadInput = document.getElementById("imageUploadInput");
        const submitButton = document.getElementById("submitButton");
        const cancelButton = document.getElementById("cancelButton");
        const movieList = document.getElementById("movieList");

        addMovieButton.addEventListener("click", () => {
            document.querySelector(".mypost").style.display = "block";
        });

        cancelButton.addEventListener("click", () => {
            clearForm();
        });

 submitButton.addEventListener("click", () => {
    const movieTitle = movieTitleInput.value.trim();
    const movieDescription = movieDescriptionTextarea.value;
    const myComment = myCommentTextarea.value;
    const rating = ratingSelect.value;
    const imageFile = imageUploadInput.files[0];

    // 파일이 선택되지 않았을 때의 처리 추가
    const imageUrl = imageFile ? URL.createObjectURL(imageFile) : "";

    if (movieTitle && movieDescription && myComment && rating && imageFile) {
        var formData = new FormData();
        formData.append("movieTitleInput", movieTitle);
        formData.append("movieDescriptionTextarea", movieDescription);
        formData.append("myCommentTextarea", myComment);
        formData.append("ratingSelect", rating);
        formData.append("imageUploadInput", imageFile);

        $.ajax({
            type: "POST",
            url: "/save_movie",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log(response);
                clearForm();
                location.reload();  // Or update the movie list manually here
            },
            error: function(err) {
                console.log(err);
            }
        });
    } else {
        alert("모든 필드를 채워주세요");
    }
});

  
        function clearForm() {
            movieTitleInput.value = "";
            movieDescriptionTextarea.value = "";
            myCommentTextarea.value = "";
            ratingSelect.value = "";
            imageUploadInput.value = "";
            document.querySelector(".mypost").style.display = "none";
        }
        
        $("#submitButton").click(function(event) {
            event.preventDefault();  // Prevent the form from being submitted normally

            const movieTitle = movieTitleInput.value.trim();
            const movieDescription = movieDescriptionTextarea.value;
            const myComment = myCommentTextarea.value;
            const rating = ratingSelect.value;
            const imageFile = imageUploadInput.files[0];

            if (!movieTitle || !movieDescription || !myComment || !rating || !imageFile) {
                alert("모든 필드를 채워주세요");
                return;
            }
            
            var formData = new FormData();
            formData.append("movieTitleInput", movieTitle);
            formData.append("movieDescriptionTextarea", movieDescription);
            formData.append("myCommentTextarea", myComment);
            formData.append("ratingSelect", rating);
            formData.append("imageUploadInput", imageFile);

            $.ajax({
                type: "POST",
                url: "/save_movie",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log(response);
                    clearForm();
                    location.reload();  // Or update the movie list manually here
                },
                error: function(err) {
                    console.log(err);
                }
            });
        });

        function clearForm() {
            movieTitleInput.value = "";
            movieDescriptionTextarea.value = "";
            myCommentTextarea.value = "";
            ratingSelect.selectedIndex = 0;
            imageUploadInput.value = "";
            document.querySelector(".mypost").style.display = "none";
        }
        $(document).ready(function() {
            $.getJSON("/get_movies", function(data) {
                for (let i = 0; i < data.length; i++) {
                    let movie = data[i];
                    const card = document.createElement("div");
                    card.classList.add("col");
                    card.innerHTML = `
                        <div class="card h-100">
                            <img src="/image/${movie._id.$oid}" class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">${movie.movie_title}</h5>
                                <p class="card-text">${movie.movie_description}</p>
                                <p>${"⭐".repeat(movie.rating)}</p>
                                <p class="mycomment">${movie.my_comment}</p>
                            </div>
                        </div>
                    `;
                    movieList.appendChild(card);
                }
            });
        });

    </script>
</body>

</html>